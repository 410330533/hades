# Jd店铺订单下载异常告警调查
前几天，每天早上到公司，都收到一堆告警邮件，非常有规律，早上5点开始，到5点半结束。告警邮件的内容，是Jd店铺订单下载异常。

## Jd店铺订单是如何下载的？
我们会用上一次下载完成的时间，作为开始时间，结束时间为开始时间+4h，请求Jd接口，然后获取这段时间内所有的订单。然后将结束时间，记录下来，作为下次的开始时间。

## Jd店铺订单下载的监控是如何做的？
我们会开一个cronjob，去不停的检测订单下载时记录的时间。一旦发现当前时间超过订单下载时间10分钟以上，则认为下载有问题，发告警邮件。

## 调查过程
然后，基于上面的逻辑，看代码，觉得可能出问题的地方在请求Jd接口。但是日志不够详细，无法判断接口调用到底耗费多少时间，于是加日志，第二天继续观察。

第二天，继续收到有规律告警邮件，并且看了昨天的Jd接口调用日志，发现耗费时间不长。于是，再看代码，觉得问题可能出现在db。为了验证猜想，继续加日志。

第三天，继续收到有规律告警邮件，看日志，确实时flush到db的时候，耗费了很长时间（将近半小时）。为什么会这样呢？从代码上看，没有什么问题，于是猜测是db备份引起的（其实前一天，想着是db的问题，就猜测可能是db备份引起的）。于是看了备份的cronjob，发现是早上6点。看了生成的备份文件，文件名确实也显示6点（文件名为备份时间）。难道不是备份引起的？那还有什么原因呢？去问了下同事TH。原来，公司买了其他的备份服务，刚好在5点会备份db。至此，问题清楚了。

## 解决方案
- 备份db切换至从库
- 咨询服务商，为什么备份时会锁表
